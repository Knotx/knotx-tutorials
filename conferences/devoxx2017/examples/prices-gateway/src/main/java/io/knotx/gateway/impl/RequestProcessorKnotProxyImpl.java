/*
 * Copyright (C) 2016 Cognifide Limited
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.knotx.gateway.impl;

import java.util.NoSuchElementException;
import java.util.Set;

import io.knotx.dataobjects.ClientResponse;
import io.knotx.dataobjects.KnotContext;
import io.knotx.knot.AbstractKnotProxy;
import io.netty.handler.codec.http.HttpResponseStatus;
import io.vertx.core.buffer.Buffer;
import io.vertx.core.http.HttpHeaders;
import rx.Single;

public class RequestProcessorKnotProxyImpl extends AbstractKnotProxy {

  private final static String RESPONSE = "[\n"
      + "        [1167692400000, 61.05],\n"
      + "        [1167778800000, 58.32],\n"
      + "        [1167865200000, 57.35],\n"
      + "        [1167951600000, 56.31],\n"
      + "        [1168210800000, 55.55],\n"
      + "        [1168297200000, 55.64],\n"
      + "        [1168383600000, 54.02],\n"
      + "        [1168470000000, 51.88],\n"
      + "        [1168556400000, 52.99],\n"
      + "        [1168815600000, 52.99],\n"
      + "        [1168902000000, 51.21],\n"
      + "        [1168988400000, 52.24],\n"
      + "        [1169074800000, 50.48],\n"
      + "        [1169161200000, 51.99],\n"
      + "        [1169420400000, 51.13],\n"
      + "        [1169506800000, 55.04],\n"
      + "        [1169593200000, 55.37],\n"
      + "        [1169679600000, 54.23],\n"
      + "        [1169766000000, 55.42],\n"
      + "        [1170025200000, 54.01],\n"
      + "        [1170111600000, 56.97],\n"
      + "        [1170198000000, 58.14],\n"
      + "        [1170284400000, 58.14],\n"
      + "        [1170370800000, 59.02],\n"
      + "        [1170630000000, 58.74],\n"
      + "        [1170716400000, 58.88],\n"
      + "        [1170802800000, 57.71],\n"
      + "        [1170889200000, 59.71],\n"
      + "        [1170975600000, 59.89],\n"
      + "        [1171234800000, 57.81],\n"
      + "        [1171321200000, 59.06],\n"
      + "        [1171407600000, 58.00],\n"
      + "        [1171494000000, 57.99],\n"
      + "        [1171580400000, 59.39],\n"
      + "        [1171839600000, 59.39],\n"
      + "        [1171926000000, 58.07],\n"
      + "        [1172012400000, 60.07],\n"
      + "        [1172098800000, 61.14],\n"
      + "        [1172444400000, 61.39],\n"
      + "        [1172530800000, 61.46],\n"
      + "        [1172617200000, 61.79],\n"
      + "        [1172703600000, 62.00],\n"
      + "        [1172790000000, 60.07],\n"
      + "        [1173135600000, 60.69],\n"
      + "        [1173222000000, 61.82],\n"
      + "        [1173308400000, 60.05],\n"
      + "        [1173654000000, 58.91],\n"
      + "        [1173740400000, 57.93],\n"
      + "        [1173826800000, 58.16],\n"
      + "        [1173913200000, 57.55],\n"
      + "        [1173999600000, 57.11],\n"
      + "        [1174258800000, 56.59],\n"
      + "        [1174345200000, 59.61],\n"
      + "        [1174518000000, 61.69],\n"
      + "        [1174604400000, 62.28],\n"
      + "        [1174860000000, 62.91],\n"
      + "        [1174946400000, 62.93],\n"
      + "        [1175032800000, 64.03],\n"
      + "        [1175119200000, 66.03],\n"
      + "        [1175205600000, 65.87],\n"
      + "        [1175464800000, 64.64],\n"
      + "        [1175637600000, 64.38],\n"
      + "        [1175724000000, 64.28],\n"
      + "        [1175810400000, 64.28],\n"
      + "        [1176069600000, 61.51],\n"
      + "        [1176156000000, 61.89],\n"
      + "        [1176242400000, 62.01],\n"
      + "        [1176328800000, 63.85],\n"
      + "        [1176415200000, 63.63],\n"
      + "        [1176674400000, 63.61],\n"
      + "        [1176760800000, 63.10],\n"
      + "        [1176847200000, 63.13],\n"
      + "        [1176933600000, 61.83],\n"
      + "        [1177020000000, 63.38],\n"
      + "        [1177279200000, 64.58],\n"
      + "        [1177452000000, 65.84],\n"
      + "        [1177538400000, 65.06],\n"
      + "        [1177624800000, 66.46],\n"
      + "        [1177884000000, 64.40],\n"
      + "        [1178056800000, 63.68],\n"
      + "        [1178143200000, 63.19],\n"
      + "        [1178229600000, 61.93],\n"
      + "        [1178488800000, 61.47],\n"
      + "        [1178575200000, 61.55],\n"
      + "        [1178748000000, 61.81],\n"
      + "        [1178834400000, 62.37],\n"
      + "        [1179093600000, 62.46],\n"
      + "        [1179180000000, 63.17],\n"
      + "        [1179266400000, 62.55],\n"
      + "        [1179352800000, 64.94],\n"
      + "        [1179698400000, 66.27],\n"
      + "        [1179784800000, 65.50],\n"
      + "        [1179871200000, 65.77],\n"
      + "        [1179957600000, 64.18],\n"
      + "        [1180044000000, 65.20],\n"
      + "        [1180389600000, 63.15],\n"
      + "        [1180476000000, 63.49],\n"
      + "        [1180562400000, 65.08],\n"
      + "        [1180908000000, 66.30],\n"
      + "        [1180994400000, 65.96],\n"
      + "        [1181167200000, 66.93],\n"
      + "        [1181253600000, 65.98],\n"
      + "        [1181599200000, 65.35],\n"
      + "        [1181685600000, 66.26],\n"
      + "        [1181858400000, 68.00],\n"
      + "        [1182117600000, 69.09],\n"
      + "        [1182204000000, 69.10],\n"
      + "        [1182290400000, 68.19],\n"
      + "        [1182376800000, 68.19],\n"
      + "        [1182463200000, 69.14],\n"
      + "        [1182722400000, 68.19],\n"
      + "        [1182808800000, 67.77],\n"
      + "        [1182895200000, 68.97],\n"
      + "        [1182981600000, 69.57],\n"
      + "        [1183068000000, 70.68],\n"
      + "        [1183327200000, 71.09],\n"
      + "        [1183413600000, 70.92],\n"
      + "        [1183586400000, 71.81],\n"
      + "        [1183672800000, 72.81],\n"
      + "        [1183932000000, 72.19],\n"
      + "        [1184018400000, 72.56],\n"
      + "        [1184191200000, 72.50],\n"
      + "        [1184277600000, 74.15],\n"
      + "        [1184623200000, 75.05],\n"
      + "        [1184796000000, 75.92],\n"
      + "        [1184882400000, 75.57],\n"
      + "        [1185141600000, 74.89],\n"
      + "        [1185228000000, 73.56],\n"
      + "        [1185314400000, 75.57],\n"
      + "        [1185400800000, 74.95],\n"
      + "        [1185487200000, 76.83],\n"
      + "        [1185832800000, 78.21],\n"
      + "        [1185919200000, 76.53],\n"
      + "        [1186005600000, 76.86],\n"
      + "        [1186092000000, 76.00],\n"
      + "        [1186437600000, 71.59],\n"
      + "        [1186696800000, 71.47],\n"
      + "        [1186956000000, 71.62],\n"
      + "        [1187042400000, 71.00],\n"
      + "        [1187301600000, 71.98],\n"
      + "        [1187560800000, 71.12],\n"
      + "        [1187647200000, 69.47],\n"
      + "        [1187733600000, 69.26],\n"
      + "        [1187820000000, 69.83],\n"
      + "        [1187906400000, 71.09],\n"
      + "        [1188165600000, 71.73],\n"
      + "        [1188338400000, 73.36],\n"
      + "        [1188511200000, 74.04],\n"
      + "        [1188856800000, 76.30],\n"
      + "        [1189116000000, 77.49],\n"
      + "        [1189461600000, 78.23],\n"
      + "        [1189548000000, 79.91],\n"
      + "        [1189634400000, 80.09],\n"
      + "        [1189720800000, 79.10],\n"
      + "        [1189980000000, 80.57],\n"
      + "        [1190066400000, 81.93],\n"
      + "        [1190239200000, 83.32],\n"
      + "        [1190325600000, 81.62],\n"
      + "        [1190584800000, 80.95],\n"
      + "        [1190671200000, 79.53],\n"
      + "        [1190757600000, 80.30],\n"
      + "        [1190844000000, 82.88],\n"
      + "        [1190930400000, 81.66],\n"
      + "        [1191189600000, 80.24],\n"
      + "        [1191276000000, 80.05],\n"
      + "        [1191362400000, 79.94],\n"
      + "        [1191448800000, 81.44],\n"
      + "        [1191535200000, 81.22],\n"
      + "        [1191794400000, 79.02],\n"
      + "        [1191880800000, 80.26],\n"
      + "        [1191967200000, 80.30],\n"
      + "        [1192053600000, 83.08],\n"
      + "        [1192140000000, 83.69],\n"
      + "        [1192399200000, 86.13],\n"
      + "        [1192485600000, 87.61],\n"
      + "        [1192572000000, 87.40],\n"
      + "        [1192658400000, 89.47],\n"
      + "        [1192744800000, 88.60],\n"
      + "        [1193004000000, 87.56],\n"
      + "        [1193090400000, 87.56],\n"
      + "        [1193176800000, 87.10],\n"
      + "        [1193263200000, 91.86],\n"
      + "        [1193612400000, 93.53],\n"
      + "        [1193698800000, 94.53],\n"
      + "        [1193871600000, 95.93],\n"
      + "        [1194217200000, 93.98],\n"
      + "        [1194303600000, 96.37],\n"
      + "        [1194476400000, 95.46],\n"
      + "        [1194562800000, 96.32],\n"
      + "        [1195081200000, 93.43],\n"
      + "        [1195167600000, 95.10],\n"
      + "        [1195426800000, 94.64],\n"
      + "        [1195513200000, 95.10],\n"
      + "        [1196031600000, 97.70],\n"
      + "        [1196118000000, 94.42],\n"
      + "        [1196204400000, 90.62],\n"
      + "        [1196290800000, 91.01],\n"
      + "        [1196377200000, 88.71],\n"
      + "        [1196636400000, 88.32],\n"
      + "        [1196809200000, 90.23],\n"
      + "        [1196982000000, 88.28],\n"
      + "        [1197241200000, 87.86],\n"
      + "        [1197327600000, 90.02],\n"
      + "        [1197414000000, 92.25],\n"
      + "        [1197586800000, 90.63],\n"
      + "        [1197846000000, 90.63],\n"
      + "        [1197932400000, 90.49],\n"
      + "        [1198018800000, 91.24],\n"
      + "        [1198105200000, 91.06],\n"
      + "        [1198191600000, 90.49],\n"
      + "        [1198710000000, 96.62],\n"
      + "        [1198796400000, 96.00],\n"
      + "        [1199142000000, 99.62],\n"
      + "        [1199314800000, 99.18],\n"
      + "        [1199401200000, 95.09],\n"
      + "        [1199660400000, 96.33],\n"
      + "        [1199833200000, 95.67],\n"
      + "        [1200351600000, 91.90],\n"
      + "        [1200438000000, 90.84],\n"
      + "        [1200524400000, 90.13],\n"
      + "        [1200610800000, 90.57],\n"
      + "        [1200956400000, 89.21],\n"
      + "        [1201042800000, 86.99],\n"
      + "        [1201129200000, 89.85],\n"
      + "        [1201474800000, 90.99],\n"
      + "        [1201561200000, 91.64],\n"
      + "        [1201647600000, 92.33],\n"
      + "        [1201734000000, 91.75],\n"
      + "        [1202079600000, 90.02],\n"
      + "        [1202166000000, 88.41],\n"
      + "        [1202252400000, 87.14],\n"
      + "        [1202338800000, 88.11],\n"
      + "        [1202425200000, 91.77],\n"
      + "        [1202770800000, 92.78],\n"
      + "        [1202857200000, 93.27],\n"
      + "        [1202943600000, 95.46],\n"
      + "        [1203030000000, 95.46],\n"
      + "        [1203289200000, 101.74],\n"
      + "        [1203462000000, 98.81],\n"
      + "        [1203894000000, 100.88],\n"
      + "        [1204066800000, 99.64],\n"
      + "        [1204153200000, 102.59],\n"
      + "        [1204239600000, 101.84],\n"
      + "        [1204498800000, 99.52],\n"
      + "        [1204585200000, 99.52],\n"
      + "        [1204671600000, 104.52],\n"
      + "        [1204758000000, 105.47],\n"
      + "        [1204844400000, 105.15],\n"
      + "        [1205103600000, 108.75],\n"
      + "        [1205276400000, 109.92],\n"
      + "        [1205362800000, 110.33],\n"
      + "        [1205449200000, 110.21],\n"
      + "        [1205708400000, 105.68],\n"
      + "        [1205967600000, 101.84],\n"
      + "        [1206313200000, 100.86],\n"
      + "        [1206399600000, 101.22],\n"
      + "        [1206486000000, 105.90],\n"
      + "        [1206572400000, 107.58],\n"
      + "        [1206658800000, 105.62],\n"
      + "        [1206914400000, 101.58],\n"
      + "        [1207000800000, 100.98],\n"
      + "        [1207173600000, 103.83],\n"
      + "        [1207260000000, 106.23],\n"
      + "        [1207605600000, 108.50],\n"
      + "        [1207778400000, 110.11],\n"
      + "        [1207864800000, 110.14],\n"
      + "        [1208210400000, 113.79],\n"
      + "        [1208296800000, 114.93],\n"
      + "        [1208383200000, 114.86],\n"
      + "        [1208728800000, 117.48],\n"
      + "        [1208815200000, 118.30],\n"
      + "        [1208988000000, 116.06],\n"
      + "        [1209074400000, 118.52],\n"
      + "        [1209333600000, 118.75],\n"
      + "        [1209420000000, 113.46],\n"
      + "        [1209592800000, 112.52],\n"
      + "        [1210024800000, 121.84],\n"
      + "        [1210111200000, 123.53],\n"
      + "        [1210197600000, 123.69],\n"
      + "        [1210543200000, 124.23],\n"
      + "        [1210629600000, 125.80],\n"
      + "        [1210716000000, 126.29],\n"
      + "        [1211148000000, 127.05],\n"
      + "        [1211320800000, 129.07],\n"
      + "        [1211493600000, 132.19],\n"
      + "        [1211839200000, 128.85],\n"
      + "        [1212357600000, 127.76],\n"
      + "        [1212703200000, 138.54],\n"
      + "        [1212962400000, 136.80],\n"
      + "        [1213135200000, 136.38],\n"
      + "        [1213308000000, 134.86],\n"
      + "        [1213653600000, 134.01],\n"
      + "        [1213740000000, 136.68],\n"
      + "        [1213912800000, 135.65],\n"
      + "        [1214172000000, 134.62],\n"
      + "        [1214258400000, 134.62],\n"
      + "        [1214344800000, 134.62],\n"
      + "        [1214431200000, 139.64],\n"
      + "        [1214517600000, 140.21],\n"
      + "        [1214776800000, 140.00],\n"
      + "        [1214863200000, 140.97],\n"
      + "        [1214949600000, 143.57],\n"
      + "        [1215036000000, 145.29],\n"
      + "        [1215381600000, 141.37],\n"
      + "        [1215468000000, 136.04],\n"
      + "        [1215727200000, 146.40],\n"
      + "        [1215986400000, 145.18],\n"
      + "        [1216072800000, 138.74],\n"
      + "        [1216159200000, 134.60],\n"
      + "        [1216245600000, 129.29],\n"
      + "        [1216332000000, 130.65],\n"
      + "        [1216677600000, 127.95],\n"
      + "        [1216850400000, 127.95],\n"
      + "        [1217282400000, 122.19],\n"
      + "        [1217455200000, 124.08],\n"
      + "        [1217541600000, 125.10],\n"
      + "        [1217800800000, 121.41],\n"
      + "        [1217887200000, 119.17],\n"
      + "        [1217973600000, 118.58],\n"
      + "        [1218060000000, 120.02],\n"
      + "        [1218405600000, 114.45],\n"
      + "        [1218492000000, 113.01],\n"
      + "        [1218578400000, 116.00],\n"
      + "        [1218751200000, 113.77],\n"
      + "        [1219010400000, 112.87],\n"
      + "        [1219096800000, 114.53],\n"
      + "        [1219269600000, 114.98],\n"
      + "        [1219356000000, 114.98],\n"
      + "        [1219701600000, 116.27],\n"
      + "        [1219788000000, 118.15],\n"
      + "        [1219874400000, 115.59],\n"
      + "        [1219960800000, 115.46],\n"
      + "        [1220306400000, 109.71],\n"
      + "        [1220392800000, 109.35],\n"
      + "        [1220565600000, 106.23],\n"
      + "        [1220824800000, 106.34]\n"
      + "    ]";

  @Override
  protected Single<KnotContext> processRequest(KnotContext knotContext) {
    return Single.just(createSuccessResponse(knotContext));
  }

  @Override
  protected boolean shouldProcess(Set<String> knots) {
    return true;
  }

  @Override
  protected KnotContext processError(KnotContext knotContext, Throwable error) {
    HttpResponseStatus statusCode;
    if (error instanceof NoSuchElementException) {
      statusCode = HttpResponseStatus.NOT_FOUND;
    } else {
      statusCode = HttpResponseStatus.INTERNAL_SERVER_ERROR;
    }
    knotContext.getClientResponse().setStatusCode(statusCode.code());
    return knotContext;
  }

  private KnotContext createSuccessResponse(KnotContext inputContext) {

    ClientResponse clientResponse = new ClientResponse();

      io.vertx.rxjava.core.MultiMap headers = clientResponse.getHeaders();
      headers.add(HttpHeaders.CONTENT_LENGTH.toString().toLowerCase(),
          Integer.toString(RESPONSE.length()))
          .add("Content-Type", "application/json");

      clientResponse.setBody(Buffer.buffer(RESPONSE)).setHeaders(headers);
      clientResponse.setStatusCode(HttpResponseStatus.OK.code());

    return new KnotContext()
        .setClientRequest(inputContext.getClientRequest())
        .setClientResponse(clientResponse);
  }

  private String generateResponse() {

    return response;
  }
}
